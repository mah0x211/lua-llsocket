CC=@CC@
CFLAGS=@CFLAGS@
WARNINGS=-Wall -Wno-trigraphs -Wmissing-field-initializers -Wmissing-prototypes -Wreturn-type -Wmissing-braces -Wparentheses -Wswitch -Wunused-function -Wunused-label -Wunused-parameter -Wunused-variable -Wunused-value -Wuninitialized -Wunknown-pragmas -Wshadow -Wsign-compare
CPPFLAGS=-I. -I../deps/lua-iovec/src @CPPFLAGS@
LDFLAGS=@LIBFLAG@
LIBS=@LIBS@
TARGET=@PACKAGE@.@LIB_EXTENSION@
SRCS=$(wildcard *.c)
OBJS=$(SRCS:.c=.@OBJ_EXTENSION@)
LIBDIR=@LIBDIR@
VARS=$(wildcard ../@VARDIR@/*.txt)
TMPL=$(wildcard ../@TMPLDIR@/*.c)

ifdef LLSOCKET_COVERAGE
COVFLAGS=--coverage
endif

all: preprocess $(TARGET)

%.o: %.c
	$(CC) $(CFLAGS) $(WARNINGS) $(COVFLAGS) $(CPPFLAGS) -c $^

$(TARGET): $(OBJS)
	$(CC) -o $@ $^ $(LDFLAGS) $(COVFLAGS) $(LIBS)

preprocess:
	lua ../codegen.lua $(VARS) $(TMPL)

install:
	mkdir -p $(LIBDIR)
	cp $(TARGET) $(LIBDIR)
	rm -f $(OBJS) $(TARGET)

# cleanup
clean:
	rm -f *.o $(TARGET)
